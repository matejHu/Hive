<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Boxes to a Hive</title>
    <style>
        .container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .box {
            width: 30%;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .hive {
            width: 70%;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }

        .loadedHive {
            width: auto;
        }

        .box h3,
        .hive h3 {
            margin-top: 0;
        }

        .list {
            margin-top: 10px;
        }

        form {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        button {
            margin-top: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Styling pro rozbalovací menu */
        .hive-details {
            margin-top: 10px;
            padding-left: 10px;
            border-top: 1px solid #ddd;
            display: none;
            /* Ve výchozím stavu skryté */
        }

        /* Styling tlačítka pro rozbalení informací */
        .toggle-details {
            margin-top: 10px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
            padding: 5px;
            cursor: pointer;
            display: inline-block;
        }

        .hive-details ul {
            margin: 10px 0;
            padding-left: 20px;
            list-style-type: disc;
        }
    </style>
</head>

<body>

    <h1>Create and Assign Hives</h1>

    <!-- Formulář pro vytvoření nového úlu -->
    <form id="hiveForm">
        <label for="hive_id">Hive ID:</label>
        <input type="text" id="hive_id" placeholder="Enter Hive ID" required>

        <label for="hive_year">Hive Year:</label>
        <input type="number" id="hive_year" placeholder="Enter Hive Year" required>

        <label for="hive_name">Hive Name:</label>
        <input type="text" id="hive_name" placeholder="Enter Hive Name" required>

        <button type="submit">Create Hive</button>
    </form>

    <!-- Kontejner pro boxy a hives vedle sebe -->
    <div class="container">
        <div class="box">
            <h3>Available Boxes</h3>
            <div class="list" id="boxesList">
                <!-- Boxes se vypíší zde (s checkboxy) -->
            </div>
        </div>

        <div class="hive">
            <h3>Select Hive</h3>
            <div class="list" id="hivesList">
                <!-- Hives se vypíší zde (s radio buttony) -->
            </div>
        </div>
    </div>

    <br>
    <button id="assignButton">Assign Boxes to Hive</button>

    <script>
        // Event listener pro vytvoření úlu
        document.getElementById("hiveForm").addEventListener("submit", function (event) {
            event.preventDefault();

            let hive_id = document.getElementById("hive_id").value;
            let hive_year = document.getElementById("hive_year").value;
            let hive_name = document.getElementById("hive_name").value;

            // Odeslání nového úlu na backend (API call na server)
            fetch("/api/hives", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    hive_id: hive_id,
                    hive_year: hive_year,
                    hive_name: hive_name
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Hive created:", data);
                    loadHivesWithBoxes();  // Znovu načteme seznam úlů
                })
                .catch(error => console.error("Error creating hive:", error));
        });


        // Načtení boxes
        function loadBoxes() {
            fetch('/api/boxes')
                .then(response => response.json())
                .then(data => {
                    const boxesList = document.getElementById("boxesList");
                    boxesList.innerHTML = '';  // Vymaže předchozí výsledky

                    data.forEach(box => {
                        // Zkontroluj, jestli je box_hive_id null (nebo undefined)
                        if (box.box_hive_id === null) {
                            const boxDiv = document.createElement('div');

                            // Vytvoření checkboxu pro každý box
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = box.box_id;

                            boxDiv.appendChild(checkbox);
                            boxDiv.appendChild(document.createTextNode(
                                `Box ID: ${box.box_id}, Type: ${box.box_type}, Year: ${box.box_year}, Hive: None`
                            ));
                            boxesList.appendChild(boxDiv);
                        }
                    });
                })
                .catch(error => console.error('Error fetching boxes:', error));
        }

        // Načtení hives s přiřazenými boxy, matkami a kontrolami
        function loadHivesWithDetails() {
            fetch('/api/hivesWithDetails')
                .then(response => response.json())
                .then(data => {
                    const hivesList = document.getElementById("hivesList");
                    hivesList.innerHTML = '';  // Vymaže předchozí výsledky

                    data.forEach(hive => {
                        const hiveDiv = document.createElement('div');
                        hiveDiv.classList.add('loadedHive'); // Přidání třídy pro styling

                        // Vytvoření radio buttonu pro každý hive
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'selectedHive';
                        radio.value = hive.hive_id;

                        hiveDiv.appendChild(radio);
                        hiveDiv.appendChild(document.createTextNode(
                            `Hive ID: ${hive.hive_id}, Name: ${hive.hive_name}, Year: ${hive.hive_year}`
                        ));

                        // Vytvoření tlačítka pro rozbalení informací
                        const toggleButton = document.createElement('button');
                        toggleButton.textContent = "Show Details";
                        toggleButton.classList.add('toggle-details'); // Stylování tlačítka
                        toggleButton.addEventListener('click', () => {
                            const detailsDiv = hiveDiv.querySelector('.hive-details');
                            const isVisible = detailsDiv.style.display === 'block';
                            detailsDiv.style.display = isVisible ? 'none' : 'block';
                            toggleButton.textContent = isVisible ? "Show Details" : "Hide Details";
                        });
                        hiveDiv.appendChild(toggleButton);

                        // Kontejner pro podrobnosti o boxech, matkách a kontrolách (nejprve skrytý)
                        const detailsDiv = document.createElement('div');
                        detailsDiv.classList.add('hive-details');

                        // Zobrazení boxů
                        if (hive.boxes.length > 0) {
                            const boxesList = document.createElement('ul');
                            hive.boxes.forEach(box => {
                                const boxItem = document.createElement('li');
                                boxItem.textContent = `Box ID: ${box.box_id}, Type: ${box.box_type}, Year: ${box.box_year}`;
                                boxesList.appendChild(boxItem);
                            });
                            detailsDiv.appendChild(boxesList);
                        } else {
                            const noBoxes = document.createElement('p');
                            noBoxes.textContent = 'No boxes assigned to this hive.';
                            detailsDiv.appendChild(noBoxes);
                        }

                        // Zobrazení matek
                        if (hive.mothers.length > 0) {
                            const mothersList = document.createElement('ul');
                            hive.mothers.forEach(mother => {
                                const motherItem = document.createElement('li');
                                motherItem.textContent = `Mother ID: ${mother.mother_id}, Origin: ${mother.mother_origin}, Year: ${mother.mother_year}, Notes: ${mother.mother_notes}`;
                                mothersList.appendChild(motherItem);
                            });
                            detailsDiv.appendChild(mothersList);
                        } else {
                            const noMothers = document.createElement('p');
                            noMothers.textContent = 'No mothers assigned to this hive.';
                            detailsDiv.appendChild(noMothers);
                        }

                        // Zobrazení kontrol
                        if (hive.checkups.length > 0) {
                            const checkupsList = document.createElement('ul');
                            hive.checkups.forEach(checkup => {
                                const checkupItem = document.createElement('li');
                                checkupItem.textContent = `Checkup ID: ${checkup.checkup_id}, Type: ${checkup.checkup_type}, Flyby: ${checkup.checkup_flyby}, Date: ${checkup.checkup_date}, Note: ${checkup.checkup_note}`;
                                checkupsList.appendChild(checkupItem);
                            });
                            detailsDiv.appendChild(checkupsList);
                        } else {
                            const noCheckups = document.createElement('p');
                            noCheckups.textContent = 'No checkups assigned to this hive.';
                            detailsDiv.appendChild(noCheckups);
                        }

                        hiveDiv.appendChild(detailsDiv);  // Přidání podrobností do divu úlu

                        hivesList.appendChild(hiveDiv);
                    });
                })
                .catch(error => console.error('Error fetching hives with details:', error));
        }

        // Získání označených boxů
        function getSelectedBoxes() {
            const checkboxes = document.querySelectorAll('#boxesList input[type="checkbox"]:checked');
            let selectedBoxes = [];

            checkboxes.forEach(checkbox => {
                selectedBoxes.push(checkbox.value);  // Ulož ID vybraného boxu
            });

            return selectedBoxes;
        }

        // Získání vybraného úlu
        function getSelectedHive() {
            const radioButtons = document.querySelectorAll('#hivesList input[type="radio"]:checked');
            if (radioButtons.length > 0) {
                return radioButtons[0].value;  // Vrátí ID vybraného úlu
            } else {
                return null;
            }
        }

        // Event listener pro přiřazení boxů k úlu
        document.getElementById("assignButton").addEventListener("click", function () {
            const selectedBoxes = getSelectedBoxes();
            const selectedHive = getSelectedHive();

            if (selectedBoxes.length === 0 || !selectedHive) {
                alert("Please select at least one box and one hive.");
                return;
            }

            // Získání počtu přiřazených boxů pro vybraný úl
            fetch(`/api/hiveBoxCount/${selectedHive}`)
                .then(response => response.json())
                .then(data => {
                    const currentBoxCount = parseInt(data.box_count);
                    const totalBoxCount = currentBoxCount + selectedBoxes.length;

                    // Kontrola, zda nebude překročen limit 5 boxů
                    if (totalBoxCount > 5) {
                        alert("This hive cannot have more than 5 boxes.");
                        return;  // Přerušení operace
                    }

                    // Pokud je vše v pořádku, odeslání vybraných boxů a úlu na backend
                    fetch('/api/assignBoxesToHive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            boxes: selectedBoxes,
                            hive_id: selectedHive
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert("Boxes successfully assigned to hive.");
                                loadBoxes(); // Aktualizuje seznam boxů
                                loadHivesWithBoxes();
                            } else {
                                alert("Error assigning boxes to hive.");
                            }
                        })
                        .catch(error => console.error('Error assigning boxes to hive:', error));
                })
                .catch(error => console.error('Error fetching box count:', error));
        });

        // Načtení dat při načtení stránky
        window.onload = function () {
            loadBoxes();
            loadHivesWithDetails();
        };
    </script>

</body>

</html>