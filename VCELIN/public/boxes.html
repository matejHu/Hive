<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/boxes.css">
    <title>Boxes CRD</title>

</head>

<body>

    <!-- Horní panel -->
    <div class="navbar">
        <a href="vizualizace.html">Vizualizace</a>
        <a href="readme.html">Pomoc</a>
    </div>

    <div class="content">

        <form id="boxForm">
            <label for="box_type">Box Type:</label>
            <select id="box_type" required>
                <option value="" disabled selected>Select Box Type</option>
                <option value="plodiště">Plodiště</option>
                <option value="medník">Medník</option>
            </select>

            <label for="box_year">Year:</label>
            <input type="number" id="box_year" placeholder="Year" min="2000">

            <label for="box_notes">Notes:</label>
            <input type="text" id="box_notes" placeholder="Notes" maxlength="200">

            <label for="box_hive_id">Hive:</label>
            <select id="box_hive_id">
                <option value="" disabled selected>Select Hive</option>
                <!-- Dynamicky se sem vloží data z databáze -->
            </select>

            <button type="submit">Create new box</button>
        </form>

        <h1>Read All Records</h1>

        <button id="loadButton" onclick="loadRecords()">Load All Records</button>

        <div id="results"></div>
    </div>
    <script>
        document.getElementById("boxForm").addEventListener("submit", function (event) {
            event.preventDefault();

            let box_type = document.getElementById("box_type").value;
            let box_year = document.getElementById("box_year").value;
            let box_notes = document.getElementById("box_notes").value;
            let box_hive_id = document.getElementById("box_hive_id").value;

            fetch("/api/boxes", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({

                    box_type: box_type,
                    box_year: box_year,
                    box_notes: box_notes,
                    box_hive_id: box_hive_id
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // Vymazání formuláře po odeslání
                    document.getElementById("boxForm").reset();
                    loadRecords();
                })
                .catch(error => console.error("Error:", error));
        });

        // Funkce pro načtení úlů z API a jejich přidání do select boxu
        function loadHivesForForm(hiveId) {
            fetch("/api/hives")
                .then(response => response.json())
                .then(data => {
                    const hiveSelect = document.getElementById("box_hive_id");

                    // Pro každé hive_id přidáme možnost do <select>
                    data.forEach(hive => {
                        const option = document.createElement("option");
                        option.value = hive.hive_id;
                        option.text = `${hive.hive_name} (ID: ${hive.hive_id})`;
                        hiveSelect.appendChild(option);
                    });

                    // Předvyplnění hodnoty, pokud existuje odpovídající možnost
                    if (hiveId) {
                        const optionExists = [...hiveSelect.options].some(option => option.value === hiveId);

                        if (optionExists) {
                            hiveSelect.value = hiveId; // Nastavení hodnoty select boxu
                        } else {
                            console.error('Hive ID z URL neodpovídá žádné možnosti v selectu.');
                        }
                    }
                })
                .catch(error => console.error("Error loading hives:", error));
        }

        function loadRecords() {
            // Fetch all records from the server
            fetch('/api/boxes')
                .then(response => response.json())
                .then(data => {
                    // Clear previous results
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = '';

                    // Display all records
                    data.forEach(record => {
                        // Create a div for each record
                        const recordDiv = document.createElement('div');
                        recordDiv.textContent = `Box ID: ${record.box_id}, Type: ${record.box_type}, Year: ${record.box_year}, Notes: ${record.box_notes}, Hive: ${record.box_hive_id}`;

                        // Add event listener for right-click (context menu)
                        recordDiv.addEventListener('contextmenu', (event) => {
                            event.preventDefault(); // Prevent default context menu
                            const confirmDelete = confirm(`Opravdu chcete smazat záznam s ID ${record.box_id}?`);
                            if (confirmDelete) {
                                deleteRecord(record.box_id); // Call the delete function
                            }
                        });

                        // Append record to the results div
                        resultsDiv.appendChild(recordDiv);
                    });

                })
                .catch(error => {
                    console.error('Error fetching records:', error);
                });
        }

        // Function to delete a record
        function deleteRecord(box_id) {
            // Call the API to delete the record
            fetch(`/api/boxes/${box_id}`, {
                method: 'DELETE',
            })
                .then(response => {
                    if (response.ok) {
                        alert(`Záznam s ID ${box_id} byl úspěšně smazán.`);
                        loadRecords(); // Reload records after deletion
                    } else {
                        alert('Došlo k chybě při mazání záznamu.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting record:', error);
                });
        }

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const hiveId = urlParams.get('hive_id'); // Získání hive_id z URL

            loadHivesForForm(hiveId);
        };
    </script>

</body>

</html>